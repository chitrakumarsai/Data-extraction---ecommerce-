SELECT PO.PO_NUM,
    PO.ITEM,
    "item_mst"."description" AS DESCRIPTION,
    TRN.TRN_NUM,
    PO.SL_QTY_ORDERED,
    TRN.TRN_QTY_ORDERED,
    TRN.TRN_QTY_SHIPPED,
    PO.STAT,
    FL.CONTAINER_NUM,
    FL.LATEST_STATUS,
    FL.LATEST_LOCATION,
    FL.LATEST_DATE,
    FL.FIRST_CONF_DEPARTURE,
    FL.LAST_CONF_DEPARTURE,
    FL.DELIVERED,
    FL.TRANSPORT AS MODE_OF_TRANSPORT,
    FL.SHIPMENT_TYPE,
    FL.LAST_SHIPMENT_BOOKED_DATE AS LAST_BOOKING_DATE,
    FL.FIRST_SHIPMENT_BOOKED_DATE AS FIRST_BOOKING_DATE,
    FL.SHIPMENT_BILL,
    FL.CONTAINER_DESCRIPTION,
    FL.EST_DELIVERY_DATE,
    FL.REV_EST_DELIVERY_DATE,
    FL.CONTAINER_TRACKING_LATEST_DATE,
    FL.CONTAINER_TRACKING_EVENT_DESCRIPTION,
    FL.REV_EST_DELIVERY_DATE AS DATE_RCVD,
    CASE FL.LATEST_STATUS WHEN 'final_destination' THEN 'Delivered' ELSE 'Not Delivered' END AS STATUS2
FROM
    (
    SELECT UPPER(REGEXP_REPLACE(BI."PUBLIC"."poitem_mst"."po_num", ' ','')) AS PO_NUM,
        UPPER(REGEXP_REPLACE(BI."PUBLIC"."poitem_mst"."item", ' ','')) AS ITEM,
        SUM(BI."PUBLIC"."poitem_mst"."qty_ordered") AS SL_QTY_ORDERED,
        BI."PUBLIC"."poitem_mst"."stat" AS STAT
    FROM BI."PUBLIC"."poitem_mst"
    WHERE  "qty_ordered" > 0 AND "item" IS NOT NULL
    GROUP BY "PO_NUM", "item", "stat"
    ) PO
LEFT JOIN
    (
      // PULLING DATA FROM TRNITEM_MST
    select UPPER(REGEXP_REPLACE(BI."PUBLIC"."trnitem_mst"."trn_num",' ','')) AS TRN_NUM,
        UPPER(REGEXP_REPLACE(BI."PUBLIC"."trnitem_mst"."item",' ','')) AS ITEM,
        SUM(BI."PUBLIC"."trnitem_mst"."qty_req") AS TRN_QTY_ORDERED,
        SUM(BI."PUBLIC"."trnitem_mst"."qty_shipped") AS TRN_QTY_SHIPPED,
        UPPER(REGEXP_REPLACE(BI."PUBLIC"."trnitem_mst"."frm_ref_num",' ','')) AS PO_NUM
    from BI."PUBLIC"."trnitem_mst"
    WHERE "qty_req" > 0
    GROUP BY TRN_NUM, ITEM, PO_NUM
    ) TRN
ON PO.PO_NUM = TRN.PO_NUM AND PO.ITEM = TRN.ITEM
LEFT JOIN "BI"."PUBLIC"."item_mst"
ON PO.ITEM = "BI"."PUBLIC"."item_mst"."item"
FULL JOIN 
    (
SELECT FS.ITEM_PRODUCT_SKU AS ITEM,
    FC.CONTAINER_NUMBER AS CONTAINER_NUM,
    LEFT(FC.CONTAINER_NUMBER, LENGTH(FC.CONTAINER_NUMBER) - 1) AS TRN_NUM,
    FC.ITEM_TOTAL_UNITS AS TRN_QTY_SHIPPED,
    FS.SHIPMENT_STATUS AS LATEST_STATUS,
    FS.ACTUAL_DEPARTURE_DATE AS CONFIRMED_DEPARTURE,
    FS.SHIPMENT_UPDATEDAT AS LATEST_DATE,
    FS.SHIPMENT_ACTUAL_DELIVERED_IN_FULL_DATE AS DELIVERED,
    FS.TRANSPORTATIONMODE AS TRANSPORT,
    FS.SHIPMENT_UPDATEDAT AS LAST_SHIPMENT_BOOKED_DATE,
    FS.SHIPMENT_CREATEDDATE AS FIRST_SHIPMENT_BOOKED_DATE,
    CASE FC.CONTAINER_SIZE WHEN 'fourty_ft' THEN '40ft' WHEN 'fourty_ft_hc' THEN '40ft hc' WHEN 'twenty_ft' THEN '20ft' WHEN 'fourty_five_ft_hc' THEN '45ft hc' ELSE FC.CONTAINER_SIZE END AS CONTAINER_DESCRIPTION,
    FS.SHIPMENT_STATUS AS CONTAINER_TRACKING_EVENT_DESCRIPTION,
    FS.SHIPMENT_UPDATEDAT AS CONTAINER_TRACKING_LATEST_DATE,
    FS.SHIPMENT_ID AS SHIPMENT_BILL,
    FCH.REV_EST_DELIVERY_DATE,
    FCH.EST_DELIVERY_DATE,
    FCI.SHIPMENT_TYPE,
    FS.SHIPMENT_ESTIMATED_DEPARTURE_DATE AS FIRST_CONF_DEPARTURE,
    FS.ACTUAL_DEPARTURE_DATE AS LAST_CONF_DEPARTURE,
    FC.ITEM_ARCHIVED_AT AS LATEST_LOCATION
FROM BI."WEBSCRAPING"."FLEX_CONTAINER_MST" FC
LEFT JOIN BI."WEBSCRAPING"."FLEX_SHIP_MST" FS
ON FC.SHIPMENT_ID = FS.SHIPMENT_ID AND FC.ITEM_ID = FS.ITEM_ID
INNER JOIN
    (
      SELECT MAX(SHIPMENT_ESTIMATED_DELIVERED_IN_FULL_DATE) AS REV_EST_DELIVERY_DATE, 
       MIN(SHIPMENT_ESTIMATED_DELIVERED_IN_FULL_DATE) AS EST_DELIVERY_DATE, SHIPMENTID AS SHIPMENT_ID
       FROM BI.WEBSCRAPING.FLEX_SHIP_HIST 
       GROUP BY SHIPMENTID 
    ) FCH
ON FS.SHIPMENT_ID = FCH.SHIPMENT_ID
LEFT JOIN
    (
SELECT FC.SHIPMENT_ID, MAX(FC.CONTAINER_SIZE), SUM(FC.ITEM_VOLUME_VALUE),
    CASE WHEN SUM(FC.ITEM_VOLUME_VALUE) > 27.71 AND MAX(FC.CONTAINER_SIZE) ='twenty_ft' THEN 'FCL' WHEN SUM(FC.ITEM_VOLUME_VALUE) > 67.7 AND MAX(FC.CONTAINER_SIZE) = 'fourty_ft' THEN 'FCL' WHEN SUM(FC.ITEM_VOLUME_VALUE) > 76 AND MAX(FC.CONTAINER_SIZE) = 'fourty_ft_hc' THEN 'FCL' WHEN SUM(FC.ITEM_VOLUME_VALUE) > 86 AND MAX(FC.CONTAINER_SIZE) = 'fourty_five_ft_hc' THEN 'FCL' ELSE 'LCL' END AS SHIPMENT_TYPE
FROM BI."WEBSCRAPING"."FLEX_CONTAINER_MST" FC
GROUP BY FC.SHIPMENT_ID ORDER BY MAX(FC.CONTAINER_SIZE) DESC
    ) FCI
ON FCH.SHIPMENT_ID = FCI.SHIPMENT_ID
) FL
ON FL.TRN_NUM = TRN.TRN_NUM
WHERE FL.CONTAINER_NUM IS NOT NULL AND TRN.TRN_NUM IS NOT NULL
GROUP BY PO.PO_NUM,PO.ITEM,DESCRIPTION,SL_QTY_ORDERED, STAT, TRN.TRN_NUM,TRN.TRN_QTY_ORDERED,TRN.TRN_QTY_SHIPPED,
CONTAINER_NUM,LATEST_STATUS,CONFIRMED_DEPARTURE,DELIVERED,TRANSPORT,SHIPMENT_TYPE,LAST_BOOKING_DATE,
FIRST_BOOKING_DATE,CONTAINER_DESCRIPTION,EST_DELIVERY_DATE,SHIPMENT_BILL, REV_EST_DELIVERY_DATE, LATEST_LOCATION,
LATEST_DATE, CONTAINER_TRACKING_LATEST_DATE,CONTAINER_TRACKING_EVENT_DESCRIPTION,LAST_CONF_DEPARTURE,LAST_CONF_DEPARTURE,FIRST_CONF_DEPARTURE;